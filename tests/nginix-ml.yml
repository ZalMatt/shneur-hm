---
- hosts: all
  become: true

  tasks:
    - name: redhat repo config
      yum_repository:
        name: nginx-ml
        description:  NGINX Mainline repo
        baseurl:  http://nginx.org/packages/mainline/centos/$releasever/$basearch/
        gpgcheck: no
        enabled:  yes
      when: ansible_facts['os_family'] == "RedHat"

    - name: redhat gpg key
      rpm_key:
        key:  https://nginx.org/keys/nginx_signing.key
        state:  present
      when: ansible_facts['os_family'] == "RedHat"

    - name: selinux must die
      command: setenforce 0
      when: ansible_facts['os_family'] == "RedHat"



    - name: debian repo config
      apt_repository:
        repo: "deb http://nginx.org/packages/mainline/ubuntu {{ ansible_facts['distribution_release'] }} nginx"
        filename: nginx-ml
        update_cache: yes
        validate_certs: no
      when: ansible_facts['os_family'] == "Debian"

    - name: ubuntu add key
      apt_key:
        url:  https://nginx.org/keys/nginx_signing.key
        state:  present
      when: ansible_facts['os_family'] == "Debian"

    - name: Install nginx
      package:
        name: nginx
        state:  present

    - name: Copy service config
      copy:
        src:  ../defaults/default.conf
        dest: /etc/nginx/conf.d/default.conf

    - name: Got vars
      include_vars:
        file: ../defaults/main.yml

    - name: Generate page
      copy:
          content:  "{{ welcome_message }}"
          dest: /tmp/index.html

    - name: Restart nginx
      systemd:
        name: nginx
        state:  restarted
